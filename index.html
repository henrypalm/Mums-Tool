<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta property="og:title" content="Mum's Furniture Catalog" />
<meta property="og:description" content="A clean and cozy furniture cataloging tool for my mom." />
<meta property="og:image" content="https://mumstool.onthewifi.com/imgs/MumsToolPreview.png" />
<meta property="og:url" content="https://mumstool.onthewifi.com/" />
<meta property="og:type" content="website" />

<title>Item Tracker</title>
<link rel="icon" href="imgs/mumsTool.ico" type="image/x-icon">
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/index-styles.css" />
</head>
<body>

<!-- WIP Overlay -->
<div id="wip-overlay">
  <span>ðŸš§ Work in Progress ðŸš§</span>
  <p>This page is currently under construction. Features may not be complete.</p>
  <label>
    <input type="checkbox" id="wip-dont-show"> Don't show this again
  </label>
  <br>
  <button onclick="closeWIP()">OK, got it</button>
</div>

<script>
const WIP_KEY = "wipDismissed";
if(localStorage.getItem(WIP_KEY) === "true"){
  document.getElementById("wip-overlay").style.display = "none";
}
function closeWIP() {
  const dontShow = document.getElementById("wip-dont-show").checked;
  if(dontShow){
    localStorage.setItem(WIP_KEY, "true");
  }
  document.getElementById("wip-overlay").style.display = "none";
}
</script>

<!-- Header and Controls -->
<div class="header-container">
  <h1>Order Tracker</h1>
  <div class="controls">
    <label>
      Filter by Customer:
      <input id="filter-customer" type="text" placeholder="Type name...">
    </label>
    <input type="file" id="upload-csv" accept=".csv">
    <button id="add-row" class="btn-add-row">Add New Row</button>
    <button id="download-csv">Export CSV</button>
    <button id="clear-orders" class="btn-clear">Clear All Orders</button>
  </div>
</div>

<!-- Table Container -->
<div id="table-container"></div>

<!-- Grand Total -->
<div id="grand-total-bar">
    Grand Total: $<span id="grand-total-value">0.00</span>
</div>

<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script>
const STORAGE_KEY = "orderTrackerData";
const TAX_RATE = 0.06;

// Initialize table data with default row if localStorage empty
let tableData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [{
    itemName: "",
    itemNumber: "",
    quantity: 0,
    price: 0,
    shipping: 0,
    fees: 0,
    returns: 0,
    tax: 0,
    total: 0,
    dateOrdered: "",
    dateShipped: "",
    customer: "",
    tracking: ""
}];

// Mutator for Total column
function totalMutator(value, data){
    let price = +data.price || 0;
    let qty = +data.quantity || 0;
    let shipping = +data.shipping || 0;
    let fees = +data.fees || 0;
    let returns = +data.returns || 0;

    let subtotal = price * qty;
    let tax = subtotal * TAX_RATE;
    let total = subtotal + tax + shipping + fees - returns;

    data.tax = tax; // store numeric tax
    return total;
}

// Remove button formatter
function removeButton(cell){
    let row = cell.getRow();
    let btn = document.createElement("button");
    btn.textContent = "âˆ’";
    btn.className = "btn-table-delete";
    btn.addEventListener("click", ()=>{
        row.delete();
        saveData();
        updateGrandTotal();
    });
    return btn;
}

// Save data to localStorage
function saveData(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()));
}

// Update grand total
function updateGrandTotal(){
    let total = table.getData().reduce((sum,row)=>sum+(+row.total||0),0);
    document.getElementById("grand-total-value").textContent = total.toFixed(2);
}

// Initialize Tabulator
let table = new Tabulator("#table-container", {
    height: "500px",
    layout: "fitDataStretch",
    data: tableData,
    columns: [
        {title:"Item Name", field:"itemName", editor:"input"},
        {title:"Item #", field:"itemNumber", editor:"input"},
        {title:"Quantity", field:"quantity", editor:"number"},
        {title:"Price", field:"price", editor:"number", formatter:"money", formatterParams:{symbol:"$", precision:2}},
        {title:"Shipping", field:"shipping", editor:"number", formatter:"money", formatterParams:{symbol:"$", precision:2}},
        {title:"Fees", field:"fees", editor:"number", formatter:"money", formatterParams:{symbol:"$", precision:2}},
        {title:"Returns", field:"returns", editor:"number", formatter:"money", formatterParams:{symbol:"$", precision:2}},
        {title:"Tax", field:"tax", editor:false, formatter:"money", formatterParams:{symbol:"$", precision:2}},
        {title:"Total", field:"total", mutator:totalMutator, editor:false, formatter:"money", formatterParams:{symbol:"$", precision:2}},
        {title:"Date Ordered", field:"dateOrdered", editor:"input", formatter:"datetime", formatterParams:{outputFormat:"MM/DD/YYYY", invalidPlaceholder:"--"}},
        {title:"Date Shipped", field:"dateShipped", editor:"input", formatter:"datetime", formatterParams:{outputFormat:"MM/DD/YYYY", invalidPlaceholder:"--"}},
        {title:"Customer", field:"customer", editor:"input"},
        {title:"Tracking", field:"tracking", editor:"input"},
        {title:"", hozAlign:"center", width:50, formatter:removeButton}
    ],
    cellEdited:function(cell){
        // recalc totals
        cell.getRow().update({total: undefined});
        saveData();
        updateGrandTotal();
    },
    rowAdded:function(){ updateGrandTotal(); },
    rowDeleted:function(){ updateGrandTotal(); }
});

// Ensure at least one row exists
if(table.getData().length===0){
    table.addRow({
        itemName:"",
        itemNumber:"",
        quantity:0,
        price:0,
        shipping:0,
        fees:0,
        returns:0,
        tax:0,
        total:0,
        dateOrdered:"",
        dateShipped:"",
        customer:"",
        tracking:""
    });
}

updateGrandTotal();

// Controls
document.getElementById("add-row").addEventListener("click", ()=>{ 
    table.addRow({
        itemName:"",
        itemNumber:"",
        quantity:0,
        price:0,
        shipping:0,
        fees:0,
        returns:0,
        tax:0,
        total:0,
        dateOrdered:"",
        dateShipped:"",
        customer:"",
        tracking:""
    });
    saveData(); 
});
document.getElementById("clear-orders").addEventListener("click", ()=>{
    if(confirm("Clear all orders? This cannot be undone.")){
        localStorage.removeItem(STORAGE_KEY);
        table.clearData();
        table.addRow({
            itemName:"",
            itemNumber:"",
            quantity:0,
            price:0,
            shipping:0,
            fees:0,
            returns:0,
            tax:0,
            total:0,
            dateOrdered:"",
            dateShipped:"",
            customer:"",
            tracking:""
        });
        saveData();
        updateGrandTotal();
    }
});
document.getElementById("filter-customer").addEventListener("input", function(){
    let val = this.value.trim();
    val ? table.setFilter("customer","like",val) : table.clearFilter();
});
document.getElementById("download-csv").addEventListener("click", ()=>table.download("csv","orders.csv"));
document.getElementById("upload-csv").addEventListener("change", function(e){
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = function(ev){
        let csv = ev.target.result;
        let parsed = Tabulator.prototype.modules.data.loaders.csv(csv);
        table.setData(parsed).then(()=>{ saveData(); updateGrandTotal(); });
    };
    reader.readAsText(file);
});
</script>

</body>
</html>
