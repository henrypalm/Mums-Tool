<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order Tracker</title>
<link rel="icon" href="imgs/mumsTool.ico" type="image/x-icon">  
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/index-styles.css" />
</head>
<body>

<div class="header-container">
  <h1>Order Tracker</h1>
  
  <div class="controls">
    <label>
      Filter by Customer:
      <input id="filter-customer" type="text" placeholder="Type name...">
    </label>
    <button id="download-csv">Export CSV</button>
    <button id="clear-orders" class="btn-clear">Clear All Orders</button>
    <input type="file" id="upload-csv" accept=".csv">
  </div>
</div>

<div id="table-container"></div>

<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script>
// Local storage key
const STORAGE_KEY = "orderTrackerData";

// Calculate row total
function calcTotal(value, data) {
    let total = ((+data.price || 0) + (+data.tax || 0) + (+data.shipping || 0) + (+data.fees || 0)) 
                * (+data.quantity || 0) - (+data.returns || 0);
    return total.toFixed(2);
}

// Load saved data from localStorage
let savedData = localStorage.getItem(STORAGE_KEY);
let tableData = savedData ? JSON.parse(savedData) : [];

// Initialize table
let table = new Tabulator("#table-container", {
    selectable: true,
    height: "500px",
    data: tableData,
    layout: "fitDataStretch",
    movableColumns: true,
    resizableColumns: true,
    pagination: false,
    columns: [
        {title: "Item Name", field: "itemName", editor: "input", sorter: "string"},
        {title: "Item #", field: "itemNumber", editor: "input", sorter: "string"},
        {title: "Price", field: "price", editor: "number", sorter: "number"},
        {title: "Quantity", field: "quantity", editor: "number", sorter: "number"},
        {title: "Shipping", field: "shipping", editor: "number", sorter: "number"},
        {title: "Fees", field: "fees", editor: "number", sorter: "number"},
        {title: "Tax", field: "tax", editor: "number", sorter: "number"},
        {title: "Returns", field: "returns", editor: "number", sorter: "number"},
        {title: "Comments", field: "comments", editor: "input"},
        {title: "Date Ordered", field: "dateOrdered", editor: "input", sorter: "date"},
        {title: "Date Shipped", field: "dateShipped", editor: "input", sorter: "date"},
        {title: "Customer", field: "customer", editor: "input", sorter: "string"},
        {title: "Tracking", field: "tracking", editor: "input", sorter: "string"},
        {title: "Total", field: "total", sorter: "number", mutator: calcTotal},
        {title: "", hozAlign: "center", formatter: actionButtons, width: 50, headerSort: false}
    ]
});

// Function to save table data to localStorage
function saveTableData() {
    let data = table.getData();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Save on any cell edit
table.on("cellEdited", saveTableData);

// Also save on row add/delete
table.on("rowAdded", saveTableData);
table.on("rowDeleted", saveTableData);

// Filter by customer
document.getElementById("filter-customer").addEventListener("input", function(){
    let val = this.value.trim();
    val ? table.setFilter("customer", "like", val) : table.clearFilter();
});

// Export CSV
document.getElementById("download-csv").addEventListener("click", function(){
    table.download("csv", "orders.csv");
});

// Import CSV
document.getElementById("upload-csv").addEventListener("change", function(e){
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = function(ev){
        let csv = ev.target.result;
        let parsed = Tabulator.prototype.modules.data.loaders.csv(csv);
        table.setData(parsed).then(saveTableData); // save after loading
    };
    reader.readAsText(file);
});

// Clear all orders
document.getElementById("clear-orders").addEventListener("click", function(){
    if(confirm("Are you sure you want to clear all orders? This cannot be undone.")){
        localStorage.removeItem(STORAGE_KEY);
        table.clearData();
    }
});

function actionButtons(cell, formatterParams, onRendered){
    return `
        <button class="btn-table-add">+</button>
        <button class="btn-table-delete">âˆ’</button>
    `;
}

// Use event delegation to handle clicks inside the table
document.getElementById("table-container").addEventListener("click", function(e){
    let row = table.getRowFromElement(e.target.closest(".tabulator-row"));
    if(e.target.classList.contains("btn-table-add")){
        table.addRow({}, true, row).then(() => saveTableData());
    }
    if(e.target.classList.contains("btn-table-delete")){
        if(row){
            row.delete();
            saveTableData();
        }
    }
});


  
</script>
</body>
</html>
